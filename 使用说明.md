# 体育馆预约程序使用说明

## 问题修复说明

原程序存在以下问题：
1. **预约失败直接停止程序** - 当预约失败时，程序会直接退出，不会继续尝试
2. **错误处理不完善** - 缺乏详细的错误日志和分类处理
3. **重试机制不足** - 没有外层重试循环，无法在失败后重新开始整个流程

## 修复内容

### 1. 改进 `make_reservation` 函数
- 增加了重试机制，支持最大尝试次数和重试间隔配置
- 改进了错误处理，对不同类型的错误进行分类处理
- 增加了详细的进度显示和错误日志

### 2. 增加外层重试循环
- 在 `main` 函数中添加了外层重试循环
- 支持配置最大重试次数和重试间隔
- 即使预约失败也会继续尝试，直到达到最大重试次数

### 3. 改进错误处理和日志
- 添加了完整的日志记录系统
- 日志会同时输出到控制台和 `reservation.log` 文件
- 对不同类型的错误进行了分类处理

### 4. 配置文件增强
在 `config.json` 中新增了以下配置项：
- `max_retries`: 最大重试次数（默认10次）
- `retry_interval`: 重试间隔秒数（默认5秒）
- `max_attempts`: 单次预约的最大尝试次数（默认1000次）
- `retry_delay`: 单次尝试间的延迟秒数（默认0.1秒）
 - `request_timeout`: 单次请求超时时间秒数（默认10秒）

## 使用方法

### 基本使用
```bash
python try.py
```

### 命令行参数使用
```bash
python try.py --time "2025-01-15 08:00:00"
```

## 配置说明

### config.json 配置项
```json
{
    "username": "你的用户名",（已废弃，登录方式见readme.md获取cookie）
    "password": "你的密码",（已废弃）
    "resource_id": "57",
    "date": "2025-09-06",
    "slots": 2,
    "period1": "4233",（已废弃）
    "sub_resource_id1": "21080",（已废弃）
    "period2": "4234",（已废弃）
    "sub_resource_id2": "21079",（已废弃）
    "max_retries": 10,
    "retry_interval": 5,
    "max_attempts": 1000,
    "retry_delay": 0.1,
    "request_timeout": 10
}
```

### 重试参数说明
- `max_retries`: 外层重试次数，即整个预约流程失败后重新开始的次数
- `retry_interval`: 外层重试间隔，每次重试之间的等待时间
- `max_attempts`: 内层重试次数，即单次预约流程中的最大尝试次数
- `retry_delay`: 内层重试间隔，单次预约尝试之间的等待时间
 - `request_timeout`: 单次 HTTP 请求的超时秒数。增大该值可延长一次尝试的最长等待时间

## 程序行为

1. **启动**: 程序启动后会显示配置参数
2. **网络检查**: 检查网络连接是否正常
3. **Cookie验证**: 验证cookie是否有效
4. **获取选项**: 拉取可预约的时间段和台号
5. **用户选择**: 用户选择要预约的时间段和台号
6. **预约尝试**: 开始预约，支持内层重试
7. **失败重试**: 如果预约失败，等待指定时间后重新开始整个流程
8. **成功结束**: 预约成功后程序结束
9. **达到上限**: 达到最大重试次数后程序结束

## 日志文件

程序运行时会生成 `reservation.log` 文件，记录详细的运行日志，包括：
- 程序启动和配置信息
- 每次重试的详细信息
- 错误信息和异常情况
- 预约成功或失败的结果

## 注意事项

1. 确保 `cookie.txt` 文件存在且包含有效的cookie
2. 确保 `config.json` 配置文件格式正确
3. 程序支持 Ctrl+C 中断
4. 建议根据网络情况调整重试参数
5. 预约失败时会自动重试，无需手动重启程序
